<html>
<head>
</head>
<body ms-controller="CommonIO">
	<div>

		<div id="profile">

			<p>SessionId: {{ sessionId }}</p>
			<p>Username: {{ username }}</p>
			<p>Nickname: {{ nickname }}</p>
			<p>Description: {{ description }}</p>
			<p><img ms-attr-src="avatarUrl" /></p>

			<button type="button" ms-click="GetMyProfile">GetMyProfile</button>
			<button type="button" ms-click="UpdateMyProfile">UpdateMyProfile</button>

		</div>

	</div>
	<div>

		<div ms-controller="Portal" ms-visible="!isHidden">

			<label>Username: <input type="text" ms-duplex="username" /></label>
			<label>Password: <input type="text" ms-duplex="password" /></label>
			<label>Nickname: <input type="text" ms-duplex="nickname" /></label>

			<button type="button" ms-click="Login">Login</button>
			<button type="button" ms-click="Register">Register</button>

		</div>

		<div ms-controller="UserSearch">

			<div>
				<label>Pattern: <input type="text" ms-duplex="pattern" /></label>
				<button type="button" ms-click="SearchUser">SearchUser</button>
			</div>

			<ul>
				<li ms-repeat="users">{{ el.nickname }}: @{{ el.username }}<button type="button" ms-click="AddContact(el.username)">AddContact</button></li>
			</ul>

		</div>

		<div ms-controller="Chat">
			
			<ul>
				<li ms-repeat="messages">{{ el.from }}: {{ el.message }}</li>
			</ul>

			<div>
				<label>To: <input type="text" ms-duplex="to" /></label>
				<label>Message: <textarea type="text" ms-duplex="message"></textarea></label>
				<button type="button" ms-click="Send">Send</button>
			</div>

		</div>

	</div>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="//cdn.bootcss.com/avalon.js/1.5.4/avalon.modern.js"></script>
	<script type="text/javascript">

	window.CommonIO = avalon.define({
		$id: 'CommonIO',

		isIOConnected: false,

		sessionId: '',

		username: '',
		nickname: '',
		description: '',
		avatarUrl: '',

		GetMyProfile: function() {

			Socket.emit('profile.get', {

				sessionId: CommonIO.sessionId,

			});

		},

		UpdateMyProfile: function() {

			Socket.emit('profile.edit', {

				sessionId: CommonIO.sessionId,
				nickname: CommonIO.nickname,
				description: '' + Date.now(),

			});

		},

	});

    window.Portal = avalon.define({

        $id: 'Portal',

        username: '',
        password: '',
        nickname: '',

        isHidden: false,

        Login: function() {

            Socket.emit('login', {

                sessionId: CommonIO.sessionId,
                username: Portal.username,
                password: Portal.password,

            });

        },

        Register: function() {

            Socket.emit('register', {

                sessionId: CommonIO.sessionId,
                username: Portal.username,
                password: Portal.password,
                nickname: Portal.nickname,

            });

        },

    });

    window.UserSearch = avalon.define({

        $id: 'UserSearch',

        pattern: '',
        users: [],

        isHidden: false,

        SearchUser: function() {

            Socket.emit('user.search', {

                sessionId: CommonIO.sessionId,
                pattern: UserSearch.pattern,

            });

        },

		AddContact: function(username) {

			Socket.emit('contact.add', {

				sessionId: CommonIO.sessionId,
				username: username,

			});

		}

    });

    window.Chat = avalon.define({

    	$id: 'Chat',

    	to: '',
    	message: '',
    	messages: [],

    	isHidden: false,

    	Send: function() {

            Socket.emit('chat', {

                sessionId: CommonIO.sessionId,
                to: Chat.to,
                message: Chat.message,

            });

    	},

    });

    window.Socket = io();

	Socket.on('connect', function() {

		CommonIO.isIOConnected = true;

	});

	Socket.on('disconnect', function() {

		CommonIO.isIOConnected = false;

	});

	Socket.on('session', function(data) {

		if(data.err) {

			alert(data.err);

		}
		else {

			CommonIO.sessionId = data.sessionId;

		}

	});

	Socket.on('register', function(data) {

		console.log(data);

		if(data.err) {

			alert(data.err);

		}
		else {

			alert('Register succeeded.');

		}

	});

	Socket.on('login', function(data) {

		console.log(data);

		if(data.err) {

			alert(data.err);

		}
		else {

			alert('Login succeeded.');
			Portal.isHidden = true;

		}

	});

	Socket.on('user.search', function(data) {

		console.log(data);
		UserSearch.users = data.users;

	});

	Socket.on('contact.add', function(data) {

		console.log(data);

	});

	Socket.on('profile.get', function(data) {

		console.log(data);

		CommonIO.username = data.username;
		CommonIO.nickname = data.nickname;
		CommonIO.description = data.description;
		CommonIO.avatarUrl = data.avatarUrl;

	});

	Socket.on('profile.edit', function(data) {

		console.log(data);

		CommonIO.nickname = data.nickname;
		CommonIO.description = data.description;

	});

	Socket.on('chat', function(data) {

		console.log(data);

	});

	Socket.on('message', function(data) {

		console.log(data);

		Chat.messages.push({
			from: data.from,
			message: data.message,
		});

	});

	</script>
</body>
</html>