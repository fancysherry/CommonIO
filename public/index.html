<html>
<head>
</head>
<body ms-controller="CommonIO">
	<div>

		<div id="profile">

			<p>SessionId: {{ sessionId }}</p>
			<p>Username: {{ username }}</p>
			<p>Nickname: {{ nickname }}</p>
			<p>Description: {{ description }}</p>
			<p><img ms-attr-src="avatarUrl" /></p>

			<button type="button" ms-click="GetMyProfile">GetMyProfile</button>

		</div>

	</div>
	<div>

		<div ms-controller="Portal" ms-visible="!isHidden">

			<label>Username: <input type="text" ms-duplex="username" /></label>
			<label>Password: <input type="text" ms-duplex="password" /></label>
			<label>Nickname: <input type="text" ms-duplex="nickname" /></label>

			<button type="button" ms-click="Login">Login</button>
			<button type="button" ms-click="Register">Register</button>

		</div>

		<div ms-controller="UserSearch">

			<label>Pattern: <input type="text" ms-duplex="pattern" /></label>
			<button type="button" ms-click="SearchUser">SearchUser</button>

		</div>

	</div>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="//cdn.bootcss.com/avalon.js/1.5.4/avalon.modern.js"></script>
	<script type="text/javascript">

	window.CommonIO = avalon.define({
		$id: 'CommonIO',

		isIOConnected: false,

		sessionId: '',

		username: '',
		nickname: '',
		description: '',
		avatarUrl: '',

		GetMyProfile: function() {

			Socket.emit('profile.get', {

				sessionId: CommonIO.sessionId,

			});

		},

		EditProfile: function() {

			Socket.emit('profile.edit', {

				sessionId: CommonIO.sessionId,
				nickname: CommonIO.nickname,
				description: '' + Date.now(),

			});

		},

		userSearch: function() {

		},

	});

    window.Portal = avalon.define({

        $id: 'Portal',

        username: '',
        password: '',
        nickname: '',

        isHidden: false,

        Login: function() {

            Socket.emit('login', {

                sessionId: CommonIO.sessionId,
                username: Portal.username,
                password: Portal.password,

            });

        },

        Register: function() {

            Socket.emit('register', {

                sessionId: CommonIO.sessionId,
                username: Portal.username,
                password: Portal.password,
                nickname: Portal.nickname,

            });

        },

    });

    window.UserSearch = avalon.define({

        $id: 'UserSearch',

        pattern: '',

        isHidden: false,

        SearchUser: function() {

            Socket.emit('user.search', {

                sessionId: CommonIO.sessionId,
                pattern: UserSearch.pattern,

            });

        },

    });

    window.Socket = io();

	Socket.on('connect', function() {

		CommonIO.isIOConnected = true;

	});

	Socket.on('disconnect', function() {

		CommonIO.isIOConnected = false;

	});

	Socket.on('session', function(data) {

		if(data.err) {

			alert(data.err);

		}
		else {

			CommonIO.sessionId = data.sessionId;

		}

	});

	Socket.on('register', function(data) {

		console.log(data);

		if(data.err) {

			alert(data.err);

		}
		else {

			alert('Register succeeded.');

		}

	});

	Socket.on('login', function(data) {

		console.log(data);

		if(data.err) {

			alert(data.err);

		}
		else {

			alert('Login succeeded.');
			Portal.isHidden = true;

		}

	});

	Socket.on('user.search', function(data) {

		console.log(data);

	});

	Socket.on('profile.get', function(data) {

		console.log(data);

		CommonIO.username = data.username;
		CommonIO.nickname = data.nickname;
		CommonIO.description = data.description;
		CommonIO.avatarUrl = data.avatarUrl;

	});

	Socket.on('profile.edit', function(data) {

		console.log(data);

		CommonIO.nickname = data.nickname;
		CommonIO.description = data.description;

	});

	</script>
</body>
</html>